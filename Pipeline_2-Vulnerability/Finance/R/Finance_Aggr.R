setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Finance")

# Load the dataset
Fin_Index <- readxl::read_xlsx("Outputs/Data/Eurostat_Fin.xlsx")
GFCF_Index <- readxl::read_xlsx("Outputs/Data/Eurostat_GFCF.xlsx")

# Load the datasets
shares <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/EMPL_shares_data.xlsx") |>
  filter(nchar(NUTS_ID) != 3) |>
  dplyr::filter(!str_detect(NUTS_ID, "ZZ"))

# Ensure data types match for merging
Fin_Index <- Fin_Index %>%
  mutate(NUTS_ID = as.character(NUTS_ID),
         Sector_ID = as.character(Sector_ID))

shares <- shares %>%
  mutate(NUTS_ID = as.character(NUTS_ID),
         Sector = as.character(Sector)) |> 
  rename("Sector_ID" = "Sector") |> 
  select(NUTS_ID, Sector_ID, Regional_Share)

# Merge national emissions with regional shares
Fin_Index_reg <- Fin_Index %>%
  left_join(shares, by = c("NUTS_ID" = "NUTS_ID", "Sector_ID" = "Sector_ID")) %>%
  mutate(Tang_Inv_reg = Tang_Inv * Regional_Share,
         Intang_Inv_reg = Intang_Inv * Regional_Share) %>%
  select(NUTS_ID, Sector_ID, Tang_Inv, Intang_Inv, Regional_Share, Tang_Inv_reg, Intang_Inv_reg)

### Normalize
Fin_Index_reg <- Fin_Index_reg %>%
  mutate(Sector_Group = if_else(Sector_ID == "C", "C", "Subsector")) %>% 
  group_by(Sector_Group) %>% 
  mutate(
    Tang_Inv_reg_n = 0.01 + 
      (Tang_Inv_reg - min(Tang_Inv_reg, na.rm = TRUE)) / 
      (max(Tang_Inv_reg, na.rm = TRUE) - min(Tang_Inv_reg, na.rm = TRUE)) * (0.99 - 0.01),
    Intang_Inv_reg_n = 0.01 + 
      (Intang_Inv_reg - min(Intang_Inv_reg, na.rm = TRUE)) / 
      (max(Intang_Inv_reg, na.rm = TRUE) - min(Intang_Inv_reg, na.rm = TRUE)) * (0.99 - 0.01)
  ) %>% 
  ungroup()

Fin_Index_reg <- Fin_Index_reg %>% 
  mutate(
    Tang_Inv_reg_n_reversed = 1 - Tang_Inv_reg_n,
    Intang_Inv_reg_n_reversed = 1 - Intang_Inv_reg_n
  )

Fin_Index_fin <- Fin_Index_reg |> 
  select(NUTS_ID, Sector_ID, Tang_Inv_reg_n_reversed, Intang_Inv_reg_n_reversed) |> 
  rename(Tang_Inv = Tang_Inv_reg_n_reversed, Intang_Inv = Intang_Inv_reg_n_reversed)

GFCF_Index <- GFCF_Index |> 
  select(NUTS_ID, GFCF) |> 
  mutate(GFCF = 0.01 + 
           (GFCF - min(GFCF, na.rm = TRUE)) / 
           (max(GFCF, na.rm = TRUE) - min(GFCF, na.rm = TRUE)) * (0.99 - 0.01)) 

GFCF_Index <- GFCF_Index |> 
  mutate(GFCF = 1 - GFCF)

Finance_Index <- GFCF_Index |> 
  left_join(Fin_Index_fin, by = c("NUTS_ID")) |> 
  select(NUTS_ID, Sector_ID, Tang_Inv, Intang_Inv, GFCF)

Finance_Index <- Finance_Index |> 
  group_by(Sector_ID) |> 
  mutate(
    Tang_Inv = ifelse(is.na(Tang_Inv), mean(Tang_Inv, na.rm = TRUE), Tang_Inv),
    Intang_Inv = ifelse(is.na(Intang_Inv), mean(Intang_Inv, na.rm = TRUE), Intang_Inv),
    GFCF = ifelse(is.na(GFCF), mean(GFCF, na.rm = TRUE), GFCF)
  ) |> 
  ungroup()

# Step 2: Calculate the Finance Index using linear aggregation (arithmetic mean)
columns <- c("Tang_Inv", "Intang_Inv", "GFCF")  # Replace with actual column names
weights <- c(0.3, 0.3, 0.4)

# Calculate the index using weighted linear aggregation
Finance_Index <- Finance_Index %>%
  rowwise() %>%
  mutate(
    Finance_Index = sum(c_across(all_of(columns)) * weights, na.rm = TRUE) /
      sum(weights[!is.na(c_across(all_of(columns)))])
  ) %>%
  ungroup()

# Step 3: Renormalize the linear aggregation to a 0-1 range
Finance_Index <- Finance_Index %>%
  mutate(Finance_Index = 0.01 + 
           (Finance_Index - min(Finance_Index, na.rm = TRUE)) / 
           (max(Finance_Index, na.rm = TRUE) - min(Finance_Index, na.rm = TRUE)) * (0.99 - 0.01))

unique_sectors <- shares %>% distinct(NUTS_ID, Sector_ID)

# Separate rows with and without sector info
Finance_Index_nonNA <- Finance_Index %>% filter(!is.na(Sector_ID))
Finance_Index_NA <- Finance_Index %>% filter(is.na(Sector_ID)) %>% select(-Sector_ID)

# For NA rows, replicate for each available sector from shares
Finance_Index_NA <- Finance_Index_NA %>% left_join(unique_sectors, by = "NUTS_ID")

# Combine back the datasets so all rows have a Sector_ID
Finance_Index <- bind_rows(Finance_Index_nonNA, Finance_Index_NA)

# Save the modified dataset
writexl::write_xlsx(Finance_Index, "Outputs/Data/Finance_Index.xlsx")

# Return the path of the saved file
return("Outputs/Data/Finance_Index.xlsx")

View(Finance_Index)



