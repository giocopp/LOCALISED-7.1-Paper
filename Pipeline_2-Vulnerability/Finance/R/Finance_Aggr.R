setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Finance")

# Load the dataset
Fin_Index <- readxl::read_xlsx("Outputs/Data/Eurostat_Fin_n.xlsx")
GFCF_Index <- readxl::read_xlsx("Outputs/Data/Eurostat_GFCF_n.xlsx")

Finance_Index <- Fin_Index |> 
  left_join(GFCF_Index, by = c("NUTS_ID", "Sector_ID")) |> 
  select(-CNTR_CODE.y) |> 
  rename(CNTR_CODE = CNTR_CODE.x)

# Calculate geometric mean
# Step 1: Identify and invert all numeric indicators (overwrite original values)
Finance_Index <- Finance_Index %>%
  mutate(across(where(is.double), ~ 1 - .))

# Step 2: Calculate geometric mean of inverted indicators
columns <- c("Tang_Inv", "Intang_Inv", "GFCF")  # Replace with actual column names
weights <- c(0.2, 0.4, 0.4)

# Calculate the weighted geometric mean
Finance_Index <- Finance_Index %>%
  rowwise() %>%
  mutate(
    Finance_Index = exp(
      sum(
        log(c_across(all_of(columns))) * weights, na.rm = TRUE
      ) / 
        sum(weights[!is.na(c_across(all_of(columns)))])  # Normalize weights for non-NA values
    )
  ) %>%
  ungroup()

# Step 3: Renormalize the geometric mean to a 0-1 range
Finance_Index <- Finance_Index %>%
  mutate(Finance_Index = 0.01 + 
           (Finance_Index - min(Finance_Index, na.rm = TRUE)) / 
           (max(Finance_Index, na.rm = TRUE) - min(Finance_Index, na.rm = TRUE)) * (0.99 - 0.01))

# Save the modified dataset
writexl::write_xlsx(Finance_Index, "Outputs/Data/Finance_Index.xlsx")

# Return the path of the saved file
return("Outputs/Data/Finance_Index.xlsx")

