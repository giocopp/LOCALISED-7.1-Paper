setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Technology")

# Load the dataset
Tech_Index <- readxl::read_xlsx("Outputs/Data/Tech_Index.xlsx")

# Fill NAs with the second lower quartile (Q1) of each numeric column
Tech_Index <- Tech_Index |> 
  mutate(across(
    where(is.numeric),
    ~ ifelse(is.na(.), quantile(., probs = 0.25, na.rm = TRUE), .),
    .names = "filled_{.col}"
  )) |> 
  mutate(across(
    starts_with("filled_"),
    .fns = ~ 1 - .,
    .names = "inverted_{.col}"
  )) |> 
  rowwise() |> 
  mutate(
    # Compute the geometric mean using all non-NA indicators
    Tech_Index = exp(mean(log(c_across(starts_with("inverted_filled_"))), na.rm = TRUE))
  ) |> 
  ungroup() |> 
  select(-starts_with("filled_"), -starts_with("inverted_"))  # Remove intermediate columns

### Normalize the index
Tech_Index <- Tech_Index |> 
  mutate(
    Tech_Index = (Tech_Index - min(Tech_Index, na.rm = TRUE)) / 
      (max(Tech_Index, na.rm = TRUE) - min(Tech_Index, na.rm = TRUE))
  ) |>
  rename(Sector_ID = Sector)

# Save the modified dataset
writexl::write_xlsx(Tech_Index, "Outputs/Data/Tech_Index.xlsx")

# Return the path of the saved file
return("Outputs/Data/Tech_Index.xlsx")
