setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Finance")

# Load the dataset
Fin_Index <- readxl::read_xlsx("Outputs/Data/Eurostat_Fin_n.xlsx")
GFCF_Index <- readxl::read_xlsx("Outputs/Data/Eurostat_GFCF_n.xlsx")

Finance_Index <- GFCF_Index |> 
  left_join(Fin_Index, by = c("NUTS_ID", "Sector_ID")) |> 
  select(-CNTR_CODE.y) |> 
  rename(CNTR_CODE = CNTR_CODE.x) |> 
  select(NUTS_ID, Sector_ID, Tang_Inv, Intang_Inv, GFCF)

Finance_Index <- Finance_Index |> 
  group_by(Sector_ID) |> 
  mutate(
    Tang_Inv = ifelse(is.na(Tang_Inv), mean(Tang_Inv, na.rm = TRUE), Tang_Inv),
    Intang_Inv = ifelse(is.na(Intang_Inv), mean(Intang_Inv, na.rm = TRUE), Intang_Inv),
    GFCF = ifelse(is.na(GFCF), mean(GFCF, na.rm = TRUE), GFCF)
  ) |> 
  ungroup()

# Calculate geometric mean
# Step 1: Identify and invert all numeric indicators (overwrite original values)
Finance_Index <- Finance_Index %>%
  mutate(across(where(is.double), ~ 1 - .))

# Step 2: Calculate geometric mean of inverted indicators
columns <- c("Tang_Inv", "Intang_Inv", "GFCF")  # Replace with actual column names
weights <- c(0.2, 0.4, 0.4)

# Calculate the index
Finance_Index <- Finance_Index %>%
  rowwise() %>%
  mutate(
    Finance_Index = sum(c_across(all_of(columns)) * weights, na.rm = TRUE) /
      sum(weights[!is.na(c_across(all_of(columns)))])
  ) %>%
  ungroup()

# Step 3: Renormalize the geometric mean to a 0-1 range
Finance_Index <- Finance_Index %>%
  mutate(Finance_Index = 0.01 + 
           (Finance_Index - min(Finance_Index, na.rm = TRUE)) / 
           (max(Finance_Index, na.rm = TRUE) - min(Finance_Index, na.rm = TRUE)) * (0.99 - 0.01))

# Save the modified dataset
writexl::write_xlsx(Finance_Index, "Outputs/Data/Finance_Index.xlsx")

# Return the path of the saved file
return("Outputs/Data/Finance_Index.xlsx")


View(Finance_Index)
