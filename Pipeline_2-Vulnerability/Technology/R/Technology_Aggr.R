setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Technology")

# Load the dataset
Tech_Index <- readxl::read_xlsx("Outputs/Data/Tech_Index.xlsx")

Tech_Index <- Tech_Index |> 
  mutate(
    Perf_Grp_Num = case_when(
      Perf_Grp == "Leader" ~ 0.99,
      Perf_Grp == "Strong" ~ 0.66,
      Perf_Grp == "Moderate" ~ 0.33,
      Perf_Grp == "Emerging" ~ 0.01,
      TRUE ~ NA_real_  # Assign NA for other cases or missing values
    )
  )

# Fill NAs with the second lower quartile (Q1) of each numeric column

Tech_Index_filled <- Tech_Index |> 
  mutate(across(
    where(is.numeric),
    ~ ifelse(is.na(.), quantile(., probs = 0.25, na.rm = TRUE), .)
  ))

Tech_Index_inverted <- Tech_Index_filled |> 
  mutate(across(
    where(is.numeric),
    ~ 1 - .
  ))

# Define the columns and corresponding weights
columns <- c("BERD", "IntlSciPub", "TopCitedPub", "PublicRDExp", "NonRDInnoExp", "InnoExpPerEmp",
             "ProdInnoSMEs", "ProcInnoSMEs", "KnowledgeEmp", "InnovEmp", "SalesNewInno", "Perf_Grp_Num")
weights <- c(0.75, 0.05, 0.1, 0.1, 0.1, 0.1, 0.05, 0.05, 0.1, 0.1, 0.1, 0.90)
weights <- weights / sum(weights)

# Calculate the weighted geometric mean
Tech_Index_linear <- Tech_Index_inverted %>%
  rowwise() %>%
  mutate(
    Tech_Index = sum(c_across(all_of(columns)) * weights, na.rm = TRUE) /
      sum(weights[!is.na(c_across(all_of(columns)))])
  ) %>%
  ungroup()

Tech_Index <- Tech_Index_linear |> 
  mutate(
    Sector_Group = if_else(Sector == "C", "C", "Subsector")  # Define group: "C" or "Subsector"
  ) |> 
  group_by(Sector_Group) |> 
  mutate(
    Tech_Index = 0.01 + 
      (Tech_Index - min(Tech_Index, na.rm = TRUE)) / 
      (max(Tech_Index, na.rm = TRUE) - min(Tech_Index, na.rm = TRUE)) * (0.99 - 0.01)
  ) |> 
  ungroup() |> 
  select(-Sector_Group) |>  # Remove temporary grouping column
  rename(Sector_ID = Sector)

Tech_Index <- Tech_Index |> 
  select(NUTS_ID, Sector_ID, Perf_Grp_Num, IntlSciPub, TopCitedPub, PublicRDExp, NonRDInnoExp, InnoExpPerEmp, ProdInnoSMEs, ProcInnoSMEs, KnowledgeEmp, InnovEmp, SalesNewInno, BERD, Tech_Index)

# Save the modified dataset
writexl::write_xlsx(Tech_Index, "Outputs/Data/Tech_Index.xlsx")

# Return the path of the saved file
return("Outputs/Data/Tech_Index.xlsx")
