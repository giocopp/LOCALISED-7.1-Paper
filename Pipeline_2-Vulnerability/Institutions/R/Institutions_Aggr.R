setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Institutions")

# Load the dataset
RCI_Inst <- readxl::read_xlsx("Outputs/Data/RCI_Inst.xlsx")

# Calculate geometric mean of inverted indicators
columns <- c("Corruption", "Accountability", "Impartiality")  # Replace with actual column names
weights <- c(0.33, 0.33, 0.33)

# Calculate the weighted mean
Inst_Index <- RCI_Inst %>%
  rowwise() %>%
  mutate(
    Inst_Index = sum(
      c_across(all_of(columns)) * weights, na.rm = TRUE
    ) / 
      sum(weights[!is.na(c_across(all_of(columns)))])  # Normalize weights for non-NA values
  ) %>%
  ungroup()

# Step 3: Renormalize the geometric mean to a 0-1 range
Inst_Index <- Inst_Index %>%
  mutate(Inst_Index = 0.01 + 
           (Inst_Index - min(Inst_Index, na.rm = TRUE)) / 
           (max(Inst_Index, na.rm = TRUE) - min(Inst_Index, na.rm = TRUE)) * (0.99 - 0.01))

### Add sectors
Sector_ID <- c("C", "C10-C12", "C13-C15", "C16-C18", "C19-C20", "C21-C22", "C23", 
               "C24", "C25+C28-C30", "C26-C27", "C31-C32", "C33")

Inst_Index <- Inst_Index |> 
  tidyr::crossing(Sector_ID) |> 
  select(CNTR_CODE, NUTS_ID, Sector_ID, everything())

# Save the modified dataset
writexl::write_xlsx(Inst_Index, "Outputs/Data/Inst_Index.xlsx")

# Return the path of the saved file
return("Outputs/Data/Inst_Index.xlsx")

