# Set working directory
setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Institutions")

### Install Necessary Packages ###
remotes::install_github("eurostat/restatapi")

libs <- c(
  "restatapi",
  "tidyverse",
  "giscoR",
  "sf",
  "classInt",
  "mice",
  "visdat",
  "VIM"
)

installed_libs <- libs %in% rownames(
  installed.packages()
)

if (any(installed_libs == FALSE)) {
  install.packages(
    libs[!installed_libs],
    dependencies = TRUE
  )
}

invisible(
  lapply(
    libs, library,
    character.only = TRUE
  )
)

### GET DATA
### 
RCI <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/RCI_2022.xlsx", sheet = "RCI_2022_raw_data" )

RCI_Inst <- RCI |> 
  select(1:5)

RCI_Inst <- RCI_Inst |> 
  mutate(across(3:5, as.numeric))

RCI_Inst <- RCI_Inst |> 
  mutate(across(3:5, ~ ifelse(is.na(.), NA, 0.01 + (0.99 - 0.01) * ((. - min(., na.rm = TRUE)) / (max(., na.rm = TRUE) - min(., na.rm = TRUE))))))

View(RCI_Inst)

RCI_Inst <- RCI_Inst |> 
  mutate(across(3:5, ~ ifelse(is.na(.), NA, 1 - .))) |> 
  rename(Accountability = `Quality and accountability`)

base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data_plus.xlsx")

RCI_Inst <- base_data |>
  left_join(RCI_Inst, by = c("RCI_code" = "NUTS")) |>
  filter(nchar(NUTS_ID) != 2) |>
  select(CNTR_CODE, NUTS_ID, Corruption, Accountability, Impartiality)

### Impute missing values of Ceuta and Melilla using average Spain values
# Precompute mean values for Spain excluding Ceuta and Melilla
spain_means <- RCI_Inst %>%
  filter(CNTR_CODE == "ES" & !NUTS_ID %in% c("ES63", "ES64")) %>%
  summarise(across(where(is.numeric), ~ mean(., na.rm = TRUE)))

# Impute missing values for Ceuta and Melilla
RCI_Inst <- RCI_Inst %>%
  mutate(
    across(
      where(is.numeric),
      ~ ifelse(
        NUTS_ID %in% c("ES63", "ES64") & is.na(.),
        spain_means[[cur_column()]], # Use the precomputed mean for the current column
        .)))

### Save
### 

writexl::write_xlsx(RCI_Inst, "Outputs/Data/RCI_Inst.xlsx")

# Return the paths of the saved files
return("Outputs/Data/RCI_Inst.xlsx")

