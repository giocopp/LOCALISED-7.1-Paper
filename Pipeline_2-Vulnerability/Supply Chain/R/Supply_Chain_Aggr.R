setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Supply Chain")

### Read
library(readxl)

# Define the directory for outputs
output_dir <- "Outputs/Data"

# Read the Excel files
Eurostat_Exp <- read_excel(file.path(output_dir, "Eurostat_Exp.xlsx"))
Eurostat_Imp <- read_excel(file.path(output_dir, "Eurostat_Imp.xlsx"))
Eurostat_Road <- read_excel(file.path(output_dir, "Eurostat_Road.xlsx"))
Eurostat_Rail <- read_excel(file.path(output_dir, "Eurostat_Rail.xlsx"))
RCI_rtp <- read_excel(file.path(output_dir, "RCI_rtp.xlsx"))
base_data <- read_excel("~/Desktop/LOCALISED-7.1-Paper/Base Data/base_data_plus.xlsx")

### NORMALISE
### Function to normalize a data frame using min-max normalization
normalize_min_max <- function(df) {
  as.data.frame(lapply(df, function(col) {
    if (is.numeric(col)) {
      # Min-max normalization for numeric columns
      (col - min(col, na.rm = TRUE)) / (max(col, na.rm = TRUE) - min(col, na.rm = TRUE))
    } else {
      # Leave non-numeric columns as is
      col
    }
  }))
}

# Apply normalization to all datasets
Eurostat_Exp <- normalize_min_max(Eurostat_Exp)
Eurostat_Imp <- normalize_min_max(Eurostat_Imp)
Eurostat_Road <- normalize_min_max(Eurostat_Road)
Eurostat_Rail <- normalize_min_max(Eurostat_Rail)
RCI_rtp <- normalize_min_max(RCI_rtp)

### Merge
# Step 1: Prepare National-Level Data (Eurostat_Exp and Eurostat_Imp)
national_data <- Eurostat_Exp |>
  dplyr::full_join(Eurostat_Imp, by = c("NUTS_ID", "Sector")) |>
  dplyr::mutate(Country_ID = substr(NUTS_ID, 1, 2))  # Extract Country ID

# Step 2: Prepare Regional-Level Data (Eurostat_Road, Eurostat_Rail, RCI_rtp)
regional_data <- Eurostat_Road |>
  dplyr::full_join(Eurostat_Rail, by = "NUTS_ID") |>
  dplyr::full_join(RCI_rtp, by = c("NUTS_ID" = "RCI_code"))

# Step 3: Expand Regional Data to Include All Sectors
expanded_regional_data <- base_data |>
  dplyr::select(NUTS_ID) |>  # Get all regional codes
  dplyr::distinct() |> 
  tidyr::crossing(Sector = unique(national_data$Sector)) |>  # Create combinations
  dplyr::left_join(regional_data, by = "NUTS_ID") |>  # Add regional-level data
  dplyr::mutate(
    across(c(MWAY_Net, RL_Net, RT_Perf), ~ replace_na(.x, 0))  # Replace NAs with 0
  )

# Step 4: Combine National and Regional Data
final_data <- expanded_regional_data |>
  dplyr::mutate(Country_ID = substr(NUTS_ID, 1, 2)) |>  # Extract country ID from NUTS_ID
  dplyr::left_join(national_data, by = c("Country_ID" = "NUTS_ID", "Sector"))  # Join by country and sector

# Final Dataset: Ensure Desired Columns
SupCh_Index <- final_data |>
  dplyr::select(NUTS_ID, Sector, Exp, Imp, MWAY_Net, RL_Net, RT_Perf)

View(SupCh_Index)
