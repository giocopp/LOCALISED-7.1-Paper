# Set working directory
setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Supply Chain")

### Install Necessary Packages ###
remotes::install_github("eurostat/restatapi")

libs <- c(
  "restatapi",
  "tidyverse",
  "giscoR",
  "sf",
  "classInt",
  "mice",
  "visdat",
  "VIM"
)

installed_libs <- libs %in% rownames(
  installed.packages()
)

if (any(installed_libs == FALSE)) {
  install.packages(
    libs[!installed_libs],
    dependencies = TRUE
  )
}

invisible(
  lapply(
    libs, library,
    character.only = TRUE
  )
)

### GET DATA
### 
### IMPORT EXPORT DATA

indicator_df <- restatapi::get_eurostat_data(
  id = "ext_tec09",
  filters = c("WORLD", "C", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "C21", "C22", "C23", "C24", "C25", "C26", "C27", "C28", "C29", "C30", "C31", "C32", "C33", "IMP", "EXP", "THS_EUR"), 
  date_filter = c(2022, 2021, 2019, 2018),
  exact_match = T,
  label = F,
  cflags = T,
  keep_flags = T,
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "Values" = "values",
    "Sector" = "nace_r2",
    "Stk_Flow" = "stk_flow",
    "Year" = "time"
  ) |> 
  dplyr::select(NUTS_ID, Sector, Year, Stk_Flow, Values)

# Load base data
base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data_plus.xlsx") |> 
  dplyr::select(2, 3) |> 
  dplyr::filter(stringr::str_length(NUTS_ID) == 2)

Eurostat_Imp_Exp <- base_data |> 
  dplyr::left_join(indicator_df_f, by = "NUTS_ID") |> 
  dplyr::select(-NUTS_NAME)

# Impute missing 2022 values with previous years and EU avg
Eurostat_Imp_Exp <- Eurostat_Imp_Exp |> 
  dplyr::group_by(NUTS_ID, Sector, Stk_Flow) |> 
  dplyr::mutate(
    # Impute missing values by cascading from 2021 to earlier years
    Values = ifelse(Year == 2022 & is.na(Values), Values[Year == 2021], Values),
    Values = ifelse(Year == 2021 & is.na(Values), Values[Year == 2019], Values),
    Values = ifelse(Year == 2019 & is.na(Values), Values[Year == 2018], Values)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::filter(Year == 2022) |> 
  dplyr::group_by(Sector, Stk_Flow) |> 
  dplyr::mutate(
    # Impute remaining missing values with EU average for each subsector
    Values = ifelse(is.na(Values), mean(Values, na.rm = TRUE), Values)
  ) |> 
  dplyr::ungroup() |>
  select(-Year)

### Adapt the Sectors
### Step 1: Create a mapping table for aggregation
sector_mapping <- data.frame(
  Original_Sector = c("C", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "C21", "C22", "C23", "C24", "C25", "C26", "C27", "C28", "C29", "C30", "C31", "C32", "C33"),
  Aggregated_Sector = c("C", "C10-C12", "C10-C12", "C10-C12", "C13-C15", "C13-C15", "C13-C15", "C16-C18", "C16-C18", "C16-C18", "C19-C22", "C19-C22", "C19-C22", "C19-C22", "C23", "C24", "C25+C28-C30", "C26-C27", "C26-C27", "C25+C28-C30", "C25+C28-C30", "C25+C28-C30", "C31-C32", "C31-C32", "C33")
)

### Step 2: Map the original sectors to the aggregated sectors
Eurostat_Imp_Exp <- Eurostat_Imp_Exp %>%
  left_join(sector_mapping, by = c("Sector" = "Original_Sector"))

### Step 3: Aggregate data by NUTS_ID, Stk_Flow, and Aggregated_Sector
Eurostat_Imp_Exp_aggregated <- Eurostat_Imp_Exp %>%
  group_by(NUTS_ID, Stk_Flow, Aggregated_Sector) %>%
  summarise(
    Aggregated_Values = sum(Values, na.rm = TRUE),
    .groups = "drop"
  )

### Step 4: Rename columns for clarity
Eurostat_Imp_Exp <- Eurostat_Imp_Exp_aggregated %>%
  rename(Sector = Aggregated_Sector)

# Divide
Eurostat_Exp <- Eurostat_Imp_Exp |> 
  filter(Stk_Flow == "EXP") |> 
  select(-Stk_Flow) |> 
  rename(Exp = Aggregated_Values)

Eurostat_Imp <- Eurostat_Imp_Exp |> 
  filter(Stk_Flow == "IMP") |> 
  select(-Stk_Flow) |> 
  rename(Imp = Aggregated_Values)

### RAIL and ROAD NETWORK 

# Fetch the full dataset
indicator_df <- restatapi::get_eurostat_data(
  id = "tran_r_net",
  exact_match = TRUE,  # Ensure broader match
  label = FALSE,
  cflags = TRUE,
  keep_flags = TRUE
)

indicator_df <- indicator_df |> 
  tidyr::complete(
    geo = unique(indicator_df$geo),
    tra_infr = unique(indicator_df$tra_infr),
    unit = "KM",
    time = unique(indicator_df$time),
    fill = list(Values = NA)
  ) |> 
  dplyr::filter(tra_infr %in% c("MWAY", "RL") & unit == "KM" & time == 2022) |> 
  select(-time)

indicator_df_f <- indicator_df |>
  dplyr::rename(
    "NUTS_ID" = "geo",
    "Values" = "values",
    "Tra_Infr" = "tra_infr"
  ) |>
  dplyr::select(NUTS_ID, Tra_Infr, Values)

base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data_plus.xlsx") |> 
  dplyr::select(2, 3)

Eurostat_TrInfr <- base_data |>
  dplyr::left_join(indicator_df_f, by = "NUTS_ID") |>
  dplyr::select(-NUTS_NAME)

# Manually impute the missing values based on NUTS_ID and Tra_Infr
Eurostat_TrInfr <- Eurostat_TrInfr |> 
  dplyr::mutate(
    Values = case_when(
      NUTS_ID == "CY" ~ 0,  # Set CY values to 0 for both RL and MWAY
      NUTS_ID == "MT" ~ 0,  # Set MT values to 0 for both RL and MWAY
      NUTS_ID == "FI" & Tra_Infr == "MWAY" ~ Values[NUTS_ID == "SE" & Tra_Infr == "MWAY"],  # Use SE MWAY value for FI MWAY
      NUTS_ID == "IT" & Tra_Infr == "MWAY" ~ Values[NUTS_ID == "ES" & Tra_Infr == "MWAY"],  # Use ES MWAY value for IT MWAY
      NUTS_ID == "LV" & Tra_Infr == "MWAY" ~ Values[NUTS_ID == "LT" & Tra_Infr == "MWAY"],  # Use LT MWAY value for LV MWAY
      TRUE ~ Values  # Retain existing values
    )
  )

Eurostat_TrInfr

# Count the number of regions (NUTS_ID with 4 digits) per country (2-digit NUTS_ID)
region_counts <- Eurostat_TrInfr |>
  dplyr::mutate(Country_ID = substr(NUTS_ID, 1, 2)) |>
  dplyr::group_by(Country_ID) |>
  dplyr::summarize(Region_Count = n_distinct(NUTS_ID))

# Calculate country-level totals for each Tra_Infr
country_totals <- Eurostat_TrInfr |>
  dplyr::mutate(Country_ID = substr(NUTS_ID, 1, 2)) |>
  dplyr::group_by(Country_ID, Tra_Infr) |>
  dplyr::summarize(Total_Values = sum(Values, na.rm = TRUE), .groups = "drop")

# Join region counts and country totals back to the main dataset
Eurostat_TrInfr <- Eurostat_TrInfr |>
  dplyr::mutate(Country_ID = substr(NUTS_ID, 1, 2)) |>
  dplyr::left_join(region_counts, by = "Country_ID") |>
  dplyr::left_join(country_totals, by = c("Country_ID", "Tra_Infr"))

# Impute missing values by dividing country-level data by region count
Eurostat_TrInfr <- Eurostat_TrInfr |>
  dplyr::mutate(
    Values = ifelse(
      is.na(Values),
      Total_Values / Region_Count,
      Values
    )
  ) |>
  dplyr::select(-Country_ID, -Region_Count, -Total_Values)

Eurostat_Road <- Eurostat_TrInfr |> 
  dplyr::filter(Tra_Infr == "MWAY") |> 
  select(-Tra_Infr) |> 
  rename("MWAY_Net" = "Values") |> 
  dplyr::filter(nchar(NUTS_ID) != 2)

Eurostat_Rail <- Eurostat_TrInfr |> 
  dplyr::filter(Tra_Infr == "RL") |> 
  select(-Tra_Infr) |>
  rename("RL_Net" = "Values") |> 
  dplyr::filter(nchar(NUTS_ID) != 2)

### ROAD TRANSPORT PERFORMANCE

RCI <- readxl::read_xlsx("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/RCI_2022.xlsx", sheet = "RCI_2022_raw_data")

base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data_plus.xlsx") |> select(c(2, 3, 4))

RCI_rtp <- RCI |>
  select(NUTS, `Region name`, `Road transport performance`) |>
  rename("NUTS_ID" = "NUTS") |> 
  left_join(base_data, by = c("NUTS_ID" = "RCI_code")) |> 
  rename("RCI_code" = "NUTS_ID",
         "NUTS_ID" = "NUTS_ID.y",
         "RCI_name" = "Region name",
         "RT_Perf" = "Road transport performance") |> 
  select(NUTS_ID, RCI_code, RT_Perf)

### SAVE
# Define output directory
output_dir <- "Outputs/Data/"

# Create output directory if it doesn't exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Save each dataset to an Excel file
writexl::write_xlsx(Eurostat_Exp, file.path(output_dir, "Eurostat_Exp.xlsx"))
writexl::write_xlsx(Eurostat_Imp, file.path(output_dir, "Eurostat_Imp.xlsx"))
writexl::write_xlsx(Eurostat_Rail, file.path(output_dir, "Eurostat_Rail.xlsx"))
writexl::write_xlsx(RCI_rtp, file.path("Outputs/Data/RCI_rtp.xlsx"))

return("Eurostat_Exp.xlsx")
return("Eurostat_Imp.xlsx")
return("Eurostat_Rail.xlsx")
return("RCI_rtp.xlsx")
