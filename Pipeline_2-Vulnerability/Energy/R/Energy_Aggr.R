setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Energy")

# Read data
regional_energy_c <- readxl::read_xlsx("Outputs/Data/Energy_FEC_Data.xlsx")

regional_energy_c_piv_raw <- regional_energy_c |> 
  select(NUTS_ID, Sector_ID, Regional_Energy_Value_Total, Regional_Energy_Value_Fossil, Regional_Energy_Value_Renewables) |> 
  rename("Energy_Cons_TJ_Total" = "Regional_Energy_Value_Total",
         "Energy_Cons_TJ_Fossil" = "Regional_Energy_Value_Fossil",
         "Energy_Cons_TJ_Renewables" = "Regional_Energy_Value_Renewables")

regional_energy_c_piv_norm <- regional_energy_c |> 
  select(NUTS_ID, Sector_ID, Regional_Energy_Value_Norm_Total, Regional_Energy_Value_Norm_Fossil, Regional_Energy_Value_Norm_Renewables) |> 
  rename("Energy_Cons_Total" = "Regional_Energy_Value_Norm_Total",
         "Energy_Cons_Fossil" = "Regional_Energy_Value_Norm_Fossil",
         "Energy_Cons_Renewables" = "Regional_Energy_Value_Norm_Renewables")

regional_energy_c_piv_norm <- regional_energy_c_piv_norm |> 
  mutate(
    Energy_Cons_Renewables = 1 - Energy_Cons_Renewables
  )

# Summarize the total energy index per region & sector
regional_energy_sums <- regional_energy_c_piv_norm |> 
  group_by(NUTS_ID, Sector_ID) |> 
  mutate(
    Energy_Index = exp(
      0.5 * log(Energy_Cons_Total) + 
        0.25 * log(Energy_Cons_Fossil) + 
        0.25 * log(Energy_Cons_Renewables)
    )
  ) |> 
  ungroup() |>  
  distinct(NUTS_ID, Sector_ID, .keep_all = TRUE) # Retain distinct rows by NUTS_ID and Sector_ID

# Define the normalization function
regional_energy_sums <- regional_energy_sums %>%
  mutate(Sector_Group = if_else(Sector_ID == "C", "C", "Subsector")) %>% 
  group_by(Sector_Group) %>% 
  mutate(
    Energy_Index_norm = 0.01 + 
      (Energy_Index - min(Energy_Index, na.rm = TRUE)) / 
      (max(Energy_Index, na.rm = TRUE) - min(Energy_Index, na.rm = TRUE)) * (0.99 - 0.01)
  ) %>% 
  ungroup() %>% 
  select(-Energy_Index, -Sector_Group) %>% 
  rename("Energy_Index" = "Energy_Index_norm")

View(regional_energy_sums)

# Save the updated dataset
writexl::write_xlsx(
  regional_energy_c_piv_raw,
  "Outputs/Data/Energy_Data_raw.xlsx")

writexl::write_xlsx(
  regional_energy_sums,
  "Outputs/Data/Energy_Data_Index.xlsx")

return("Outputs/Data/Energy_Data_Index.xlsx")

