setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Energy")

# Read data
regional_energy_c <- readxl::read_xlsx("Outputs/Data/Energy_FEC_Data.xlsx")

regional_energy_c_piv <- regional_energy_c %>%
  pivot_wider(
    names_from = Source, # The column with values to become new column names
    values_from = c(Regional_Energy_Value, Regional_Energy_Value_Norm) # Columns to fill with values
  )

regional_energy_c_piv_raw <- regional_energy_c_piv |> 
  select(NUTS_ID, Sector_ID, Regional_Energy_Value_Total, Regional_Energy_Value_Fossil, Regional_Energy_Value_Renewables) |> 
  rename("Energy_Cons_TJ_Total" = "Regional_Energy_Value_Total",
         "Energy_Cons_TJ_Fossil" = "Regional_Energy_Value_Fossil",
         "Energy_Cons_TJ_Renewables" = "Regional_Energy_Value_Renewables")

regional_energy_c_piv_norm <- regional_energy_c_piv |> 
  select(NUTS_ID, Sector_ID, Regional_Energy_Value_Norm_Total, Regional_Energy_Value_Norm_Fossil, Regional_Energy_Value_Norm_Renewables) |> 
  rename("Energy_Cons_Total" = "Regional_Energy_Value_Norm_Total",
         "Energy_Cons_Fossil" = "Regional_Energy_Value_Norm_Fossil",
         "Energy_Cons_Renewables" = "Regional_Energy_Value_Norm_Renewables")

regional_energy_c_piv_norm <- regional_energy_c_piv_norm |> 
  mutate(
    Energy_Cons_Renewables = 1 - Energy_Cons_Renewables
  )

# Summarize the total energy index per region & sector
regional_energy_sums <- regional_energy_c_piv_norm |> 
  group_by(NUTS_ID, Sector_ID) |> 
  mutate(
    Energy_Index = exp(mean(log(Energy_Cons_Total), na.rm = TRUE)) # Adjusted to use Energy_Cons_Total
  ) |> 
  ungroup() |>  
  distinct(NUTS_ID, Sector_ID, .keep_all = TRUE) # Retain distinct rows by NUTS_ID and Sector_ID

# Get min and max of Energy_Index
min(regional_energy_sums$Energy_Index, na.rm = TRUE)
max(regional_energy_sums$Energy_Index, na.rm = TRUE)

# Define the normalization function
regional_energy_sums <- regional_energy_sums %>%
  mutate(Sector_Group = if_else(Sector_ID == "C", "C", "Other")) %>%
  group_by(Sector_Group) %>%
  mutate(Energy_Index_norm = (Energy_Index - min(Energy_Index)) / (max(Energy_Index) - min(Energy_Index))) %>%
  ungroup() %>%
  select(-Energy_Index, -Sector_Group) |> 
  rename("Energy_Index" = "Energy_Index_norm")

# Save the updated dataset
writexl::write_xlsx(
  regional_energy_c_piv_raw,
  "Outputs/Data/Energy_Data_raw.xlsx")

writexl::write_xlsx(
  regional_energy_sums,
  "Outputs/Data/Energy_Index.xlsx")

return("Outputs/Data/Energy_Data_Index.xlsx")


