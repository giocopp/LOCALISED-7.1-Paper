setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Energy")

# Install Packages
remotes::install_github("eurostat/restatapi")

libs <- c(
  "restatapi",
  "tidyverse",
  "giscoR",
  "sf",
  "classInt",
  "RColorBrewer",
  "ggnewscale"
)

installed_libs <- libs %in% rownames(installed.packages())

if (any(installed_libs == FALSE)) {
  install.packages(libs[!installed_libs], dependencies = TRUE)
}

invisible(lapply(libs, library, character.only = TRUE))

# Read data
Energy_Index_norm <- readxl::read_xlsx("Outputs/Data/Energy_Index.xlsx")

# Get Boundaries
nuts2_sf <- giscoR::gisco_get_nuts(
  nuts_level = "2",
  resolution = "3",
  year = "2021"
)

countries_sf <- giscoR::gisco_get_countries(
  resolution = "3",
  region = "EU",
  year = "2020"
)

# Filter EU Countries
eu_list <- unique(countries_sf$CNTR_ID)

eu_sf <- nuts2_sf %>%
  dplyr::filter(CNTR_CODE %in% eu_list)

overseas_codes <- c("FRY", "ES7", "PT2")

eu_sf <- eu_sf %>%
  filter(!stringr::str_sub(NUTS_ID, 1, 3) %in% overseas_codes)

# Merge with NUTS2 boundaries
mapping_sf <- eu_sf %>%
  dplyr::left_join(Energy_Index_norm, by = c("NUTS_ID"))

# Verify the merged dataset
if (nrow(mapping_sf) == 0) {
  stop("No data found after merging. Check 'NUTS_ID' consistency between datasets.")
}

# Define Lambert Projection
# Define Lambert Projection
crs_lambert <- "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +datum=WGS84 +units=m +no_defs"

# Function to Create a Map for a Specific Region and Sector
create_map <- function(region = "EU", sector = "C", output_dir = "Outputs/Plots", fixed_range = c(0, 1)) {
  # Ensure directory exists
  if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
  
  # Filter data for the specified region
  if (region == "EU") {
    region_sf <- mapping_sf
    base_sf <- eu_sf
    
    bbox <- sf::st_bbox(sf::st_transform(eu_sf, crs = crs_lambert))
    
  } else {
    region_sf <- mapping_sf %>%
      filter(CNTR_CODE == region)
    base_sf <- nuts2_sf %>%
      filter(CNTR_CODE == region)
    
    # For non-EU, use the default bounding box after projection
    bbox <- sf::st_bbox(base_sf)
  }
  
  # Filter data for the specified sector
  sector_data <- region_sf %>%
    filter(Sector_ID == sector) %>%
    mutate(Energy_Index_norm = as.numeric(Energy_Index_norm))
  
  # Apply Lambert projection to sector and base data
  base_sf <- sf::st_transform(base_sf, crs = crs_lambert)
  sector_data <- sf::st_transform(sector_data, crs = crs_lambert)
  
  # Use manually defined bbox for EU, else recalculate
  if (region != "EU") {
    bbox <- sf::st_bbox(base_sf)
  }
  
  # Define breaks and colors dynamically
  breaks <- seq(fixed_range[1], fixed_range[2], length.out = 6)
  cols <- colorRampPalette(brewer.pal(n = 9, name = "Blues"))(length(breaks) - 1)
  
  # Create the map
  map_plot <- ggplot(data = sector_data) +
    geom_sf(mapping = aes(fill = Energy_Index_norm), color = "black", size = .01) +
    geom_sf(data = base_sf, color = "black", size = .005, fill = "transparent") +
    coord_sf(
      xlim = c(bbox["xmin"], bbox["xmax"]),
      ylim = c(bbox["ymin"], bbox["ymax"]),
      expand = FALSE
    ) +
    scale_fill_gradientn(
      name = "Energy (Index)",
      colors = cols,
      breaks = breaks,
      labels = round(breaks, 2),
      limits = fixed_range,
      na.value = "grey80"
    ) +
    guides(
      fill = guide_colorbar(
        direction = "vertical",
        barheight = unit(35, "mm"),
        barwidth = unit(6, "mm"),
        title.position = "top",
        title.hjust = 0.5,
        label.position = "right",
        label.hjust = 0.5
      )
    ) +
    theme_void() +
    theme(
      legend.position = "right",
      legend.title = element_text(size = 12, color = "grey10"),
      legend.text = element_text(size = 10, color = "grey10")
    )
  
  # Save the plot
  output_path <- file.path(output_dir, paste0(region, "_", sector, "_emissions_map.png"))
  ggsave(output_path, plot = map_plot, width = 10, height = 7)
  
  # Return the path to the saved plot
  return(output_path)
}

# Example Usage
# Create a map for the EU and sector "C"
eu_map_path <- create_map(region = "EU", sector = "C10-C12")

# Create a map for Italy and sector "C10"
italy_map_path <- create_map(region = "IT", sector = "C")

unique(Energy_Index_norm$Sector_ID)
