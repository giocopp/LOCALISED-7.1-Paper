setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Energy")

### INSTALL PACKAGES

remotes::install_github(
  "eurostat/restatapi"
)

libs <- c(
  "restatapi",
  "tidyverse",
  "giscoR",
  "sf",
  "classInt"
)

installed_libs <- libs %in% rownames(
  installed.packages()
)

if (any(installed_libs == FALSE)) {
  install.packages(
    libs[!installed_libs],
    dependencies = TRUE
  )
}

invisible(
  lapply(
    libs, library,
    character.only = TRUE
  )
)

### GET DATA
### 

indicator_df <- restatapi::get_eurostat_data(
  id = "nrg_bal_c",
  filters = c("FC_IND_E", "FC_IND_IS_E", "FC_IND_CPC_E", "FC_IND_NFM_E", "FC_IND_NMM_E", "FC_IND_TE_E", "FC_IND_MAC_E",
              "FC_IND_MQ_E", "FC_IND_FBT_E", "FC_IND_PPP_E", "FC_IND_WP_E", "FC_IND_CON_E", "FC_IND_TL_E", "FC_IND_NSP_E",
              "TOTAL", "FE", "RA000", 
              "TJ"), 
  date_filter = c(2022),
  exact_match = F,
  label = F,
  cflags = T,
  keep_flags = T
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "Values" = "values",
    "Sector" = "nrg_bal",
    "Time" = "time",
    "Source" = "siec",
    "Flags" = "flags"
  ) 

Energy_c_raw_data <- indicator_df_f |> 
  mutate(Source = case_when(
    Source == "TOTAL" ~ "Total",
    Source == "RA000" ~ "Renewables",
    Source == "FE" ~ "Fossil",
    TRUE ~ Source
  ))

### Codes Mapping
code_map <- c(
  "FC_IND_E"     = "C",
  "FC_IND_FBT_E" = "C10-C12",
  "FC_IND_TL_E"  = "C13-C15",
  "FC_IND_WP_E"  = "C16-C18",
  "FC_IND_PPP_E" = "C16-C18",
  "FC_IND_CPC_E" = "C19-C20",
  "FC_IND_NMM_E" = "C23",
  "FC_IND_IS_E"  = "C24",
  "FC_IND_NFM_E" = "C24",
  "FC_IND_MAC_E" = "C25+C28-C30",
  "FC_IND_TE_E"  = "C25+C28-C30",
  "FC_IND_NSP_E" = "C21-C22",
  "FC_IND_NSP_E" = "C26-C27",
  "FC_IND_NSP_E" = "C30-C32", 
  "FC_IND_NSP_E" = "C33"
)

### Apply Mapping to Aggregate Sectors
Energy_c_raw_data <- Energy_c_raw_data |>
  mutate(Sector = recode(Sector, !!!code_map)) |> 
  rename(Energy_TJ = Values)

Energy_c_raw_data <- Energy_c_raw_data |>
  filter(!Sector %in% c("FC_IND_CON_E", "FEC2020-2030", "FC_IND_MQ_E", "FEC_EED")) |>
  group_by(NUTS_ID, Source, unit, Sector, Time) |>
  summarise(Energy_TJ = sum(Energy_TJ, na.rm = TRUE), .groups = "drop")

### DOWNSCALE 

# Load the datasets
base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data.xlsx") |> 
  dplyr::select(1, 3)

shares <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/EMPL_shares_data.xlsx") |>
  filter(nchar(NUTS_ID) != 3) |>
  dplyr::filter(!str_detect(NUTS_ID, "ZZ"))

energy_c <- Energy_c_raw_data |>
  dplyr::filter(!str_detect(NUTS_ID, "ZZ"))

# Ensure data types match for merging
energy_c <- energy_c |>
  mutate(NUTS_ID = as.character(NUTS_ID),
         Sector = as.character(Sector))

energy_c <- base_data |> 
  dplyr::left_join(
    energy_c,
    by = "NUTS_ID") |> 
  select(!NUTS_NAME) |> 
  na.omit()

shares <- shares |>
  mutate(NUTS_ID = as.character(NUTS_ID),
         Sector = as.character(Sector)) |> 
  filter(!Sector %in% c("C31-C32", "C33"))

# Filter emissions to keep only national-level data
national_energy_c <- energy_c |> 
  filter(nchar(NUTS_ID) == 2) |> 
  select(-c(unit, Time))

# Merge national emissions with regional shares
national_energy_c <- national_energy_c |>
  left_join(shares, by = c("NUTS_ID" = "Country", "Sector" = "Sector")) |> 
  rename(Country = NUTS_ID, 
         NUTS_ID = NUTS_ID.y) |> 
  select(Country, NUTS_ID, Source, Sector, Energy_TJ, Regional_Share)

# Only for total energy values, downscale to regional level
regional_energy_c <- national_energy_c |>
  mutate(Regional_Energy_TJ = if_else(Source == "Total",
                                      Energy_TJ * Regional_Share,
                                      Energy_TJ))

# regional_energy_c <- national_energy_c |>
#   mutate(Regional_Energy_TJ = Energy_TJ * Regional_Share)

# Calculate total energy per region and pivot data
regional_energy_c <- regional_energy_c |>
  group_by(NUTS_ID, Sector) |>
  summarise(
    Country = first(Country),  # Retain the country for each NUTS_ID
    Total_Regional_Energy_TJ = sum(Regional_Energy_TJ, na.rm = TRUE),
    Fossil_Regional_Energy_TJ = sum(Regional_Energy_TJ[Source == "Fossil"], na.rm = TRUE),
    RE_Regional_Energy_TJ = sum(Regional_Energy_TJ[Source == "Renewables"], na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    Fossil_Regional_Energy_Share = Fossil_Regional_Energy_TJ / Total_Regional_Energy_TJ,
    RE_Regional_Energy_Share = RE_Regional_Energy_TJ / Total_Regional_Energy_TJ
  ) |>
  select(Country, NUTS_ID, Sector, Total_Regional_Energy_TJ, Fossil_Regional_Energy_Share, RE_Regional_Energy_Share)

### Impute missing values

sum(is.na(regional_energy_c))

colnames(regional_energy_c)

# Impute missing values with sector averages for all relevant columns
regional_energy_c <- regional_energy_c %>%
  group_by(Sector) %>% 
  mutate(
    Total_Regional_Energy_TJ = ifelse(
      is.na(Total_Regional_Energy_TJ), 
      mean(Total_Regional_Energy_TJ, na.rm = TRUE), 
      Total_Regional_Energy_TJ
    ),
    Fossil_Regional_Energy_Share = ifelse(
      is.na(Fossil_Regional_Energy_Share), 
      mean(Fossil_Regional_Energy_Share, na.rm = TRUE), 
      Fossil_Regional_Energy_Share
    ),
    RE_Regional_Energy_Share = ifelse(
      is.na(RE_Regional_Energy_Share), 
      mean(RE_Regional_Energy_Share, na.rm = TRUE), 
      RE_Regional_Energy_Share
    )
  ) %>%
  ungroup()

# Check for remaining missing values
sum(is.na(regional_energy_c))

# Re-pivot data to include the 'Source' column
# Re-pivot data to include Source column and name the value column as Regional_Energy_Value
regional_energy_c <- regional_energy_c |>
  pivot_longer(
    cols = c(Total_Regional_Energy_TJ, Fossil_Regional_Energy_Share, RE_Regional_Energy_Share),
    names_to = "Source",
    values_to = "Regional_Energy_Value"
  ) |>
  mutate(
    Source = case_when(
      Source == "Total_Regional_Energy_TJ" ~ "Total",
      Source == "Fossil_Regional_Energy_Share" ~ "Fossil",
      Source == "RE_Regional_Energy_Share" ~ "Renewables",
      TRUE ~ Source
    )
  ) |>
  arrange(Country, NUTS_ID, Sector, Source)

# Normalization 
# Add a column to classify sectors as "Total" (C) or "Subsector" (all others)
regional_energy_c_n <- regional_energy_c |>
  mutate(Sector_Type = if_else(Sector == "C", "Total", "Subsector"))

# Normalize values within each combination of Source and Sector_Type
regional_energy_c_n <- regional_energy_c_n |>
  group_by(Source, Sector_Type) |>
  mutate(
    Regional_Energy_Value_Norm = 0.01 + 
      (Regional_Energy_Value - min(Regional_Energy_Value, na.rm = TRUE)) /
      (max(Regional_Energy_Value, na.rm = TRUE) - min(Regional_Energy_Value, na.rm = TRUE)) * (0.99 - 0.01)
  ) |>
  ungroup()

# View the normalized dataset
regional_energy_c <- regional_energy_c_n

# Create mapping for sector names
sector_name_map <- c(
  "C"            = "Total",
  "C10-C12"      = "Food, Beverage and Tobacco",
  "C13-C15"      = "Textiles, Leather and Wearing",
  "C16-C18"      = "Wood, Paper and Printing",
  "C19-C20"      = "Chemical and Petrolchemical", 
  "C21-C22"      = "Pharmaceutical and Plastic",
  "C23"          = "Cement, Ceramics, Glass, and Lime",
  "C24"          = "Basic Metals",
  "C26-C27"      = "Electronics and Electrical Equipment",
  "C25+C28-C30"  = "Fabricated Metals, Machinery, Vehicles and Transport Equipment"
)

# Apply mapping and rename columns
regional_energy_c <- regional_energy_c |>
  mutate(
    Sector_ID = Sector,  # Keep the original sector code
    Sector_Name = recode(Sector, !!!sector_name_map)  # Map to new names
  ) |>
  select(-Sector) |> 
  select(Country, NUTS_ID, Sector_ID, Sector_Name, Source, Regional_Energy_Value, Regional_Energy_Value_Norm)

View(regional_energy_c)

regional_energy_w <- regional_energy_c %>%
  pivot_wider(
    names_from = Source,
    values_from = c(Regional_Energy_Value, Regional_Energy_Value_Norm)
  )

# Save the updated dataset
writexl::write_xlsx(
  regional_energy_w,
  "Outputs/Data/Energy_FEC_Data.xlsx"
)

return("Outputs/Data/Energy_FEC_Data.xlsx")


View(regional_energy_w)
