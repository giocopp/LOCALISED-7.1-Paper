setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Energy")

### INSTALL PACKAGES
remotes::install_github("eurostat/restatapi")

libs <- c(
  "restatapi",
  "tidyverse",
  "giscoR",
  "sf",
  "classInt"
)

installed_libs <- libs %in% rownames(installed.packages())
if (any(installed_libs == FALSE)) {
  install.packages(libs[!installed_libs], dependencies = TRUE)
}
invisible(lapply(libs, library, character.only = TRUE))

### GET DATA
indicator_df <- restatapi::get_eurostat_data(
  id = "nrg_bal_c",
  filters = c("FC_IND_E", "FC_IND_IS_E", "FC_IND_CPC_E", "FC_IND_NFM_E", "FC_IND_NMM_E", "FC_IND_TE_E", "FC_IND_MAC_E",
              "FC_IND_MQ_E", "FC_IND_FBT_E", "FC_IND_PPP_E", "FC_IND_WP_E", "FC_IND_CON_E", "FC_IND_TL_E", "FC_IND_NSP_E",
              "TOTAL", "FE", "RA000", 
              "TJ"), 
  date_filter = c(2022),
  exact_match = F,
  label = F,
  cflags = T,
  keep_flags = T
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "Values" = "values",
    "Sector_ID" = "nrg_bal",
    "Time" = "time",
    "Source" = "siec",
    "Flags" = "flags"
  ) 

Energy_c_raw_data <- indicator_df_f |> 
  mutate(Source = case_when(
    Source == "TOTAL" ~ "Total",
    Source == "RA000" ~ "Renewables",
    Source == "FE" ~ "Fossil",
    TRUE ~ Source
  ))

### Codes Mapping
code_map <- c(
  "FC_IND_E"     = "C",
  "FC_IND_FBT_E" = "C10-C12",
  "FC_IND_TL_E"  = "C13-C15",
  "FC_IND_WP_E"  = "C16-C18",
  "FC_IND_PPP_E" = "C16-C18",
  "FC_IND_CPC_E" = "C19-C22",
  "FC_IND_NMM_E" = "C23",
  "FC_IND_IS_E"  = "C24",
  "FC_IND_NFM_E" = "C24",
  "FC_IND_MAC_E" = "C25+C28-C30",
  "FC_IND_TE_E"  = "C25+C28-C30",
  "FC_IND_NSP_E" = "C26-C27",
  "FC_IND_NSP_E" = "C30-C32", 
  "FC_IND_NSP_E" = "C33"
)

### Apply Mapping to Aggregate Sector_IDs
Energy_c_raw_data <- Energy_c_raw_data |>
  mutate(Sector_ID = recode(Sector_ID, !!!code_map)) |> 
  rename(Energy_TJ = Values)

Energy_c_raw_data <- Energy_c_raw_data |>
  filter(!Sector_ID %in% c("FC_IND_CON_E", "FEC2020-2030", "FC_IND_MQ_E", "FEC_EED")) |>
  group_by(NUTS_ID, Source, unit, Sector_ID, Time) |>
  summarise(Energy_TJ = sum(Energy_TJ, na.rm = TRUE), .groups = "drop")

### DOWNSCALE EMISSIONS
base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data.xlsx") |> 
  dplyr::select(1, 3)

shares <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/EMPL_shares_data.xlsx") |>
  filter(nchar(NUTS_ID) != 3) |>
  dplyr::filter(!str_detect(NUTS_ID, "ZZ"))

energy_c <- Energy_c_raw_data |>
  dplyr::filter(!str_detect(NUTS_ID, "ZZ")) |>
  mutate(NUTS_ID = as.character(NUTS_ID), Sector_ID = as.character(Sector_ID))

energy_c <- base_data |> 
  dplyr::left_join(energy_c, by = "NUTS_ID") |> 
  select(!NUTS_NAME) |> 
  na.omit()

shares <- shares |>
  mutate(NUTS_ID = as.character(NUTS_ID), Sector = as.character(Sector)) |> 
  filter(!Sector %in% c("C31-C32", "C33"))

national_energy_c <- energy_c |> 
  filter(nchar(NUTS_ID) == 2) |> 
  select(-c(unit, Time))

national_energy_c <- national_energy_c |>
  left_join(shares, by = c("NUTS_ID" = "Country", "Sector_ID" = "Sector")) |> 
  rename(Country = NUTS_ID, NUTS_ID = NUTS_ID.y) |> 
  select(Country, NUTS_ID, Source, Sector_ID, Energy_TJ, Regional_Share)

regional_energy_c <- national_energy_c |> 
  mutate(Regional_Energy_TJ = Energy_TJ * Regional_Share)

### NORMALIZE EMISSIONS
normalize <- function(data) {
  data$Regional_Energy_Norm <- NA
  data <- data |>
    group_by(Source) |>
    mutate(
      min_C = min(Regional_Energy_TJ[Sector_ID == "C"], na.rm = TRUE),
      max_C = max(Regional_Energy_TJ[Sector_ID == "C"], na.rm = TRUE),
      min_sub = min(Regional_Energy_TJ[startsWith(Sector_ID, "C") & Sector_ID != "C"], na.rm = TRUE),
      max_sub = max(Regional_Energy_TJ[startsWith(Sector_ID, "C") & Sector_ID != "C"], na.rm = TRUE),
      Regional_Energy_Norm = case_when(
        Sector_ID == "C" ~ (Regional_Energy_TJ - min_C) / (max_C - min_C),
        startsWith(Sector_ID, "C") & Sector_ID != "C" ~ (Regional_Energy_TJ - min_sub) / (max_sub - min_sub),
        TRUE ~ Regional_Energy_Norm
      )
    ) |>
    ungroup() |> 
    select(-min_C, -max_C, -min_sub, -max_sub)
  return(data)
}

regional_energy_c <- normalize(regional_energy_c)

regional_energy_c <- regional_energy_c |> 
  mutate(
    Regional_Energy_Norm = case_when(
      Source == "Renewables" ~ 1 - Regional_Energy_Norm,
      TRUE ~ Regional_Energy_Norm
    )
  )

### COMPUTE SHARES OF FOSSIL AND RENEWABLE ENERGY
regional_energy_c <- regional_energy_c |>
  group_by(Country, NUTS_ID, Sector_ID) |>
  mutate(
    Total_Energy_TJ = sum(Energy_TJ, na.rm = TRUE),
    Share_Fossil = case_when(Source == "Fossil" ~ Energy_TJ / Total_Energy_TJ, TRUE ~ NA_real_),
    Share_Renewables = case_when(Source == "Renewables" ~ Energy_TJ / Total_Energy_TJ, TRUE ~ NA_real_)
  ) |>
  ungroup()

regional_energy_c <- regional_energy_c |>
  group_by(Country, NUTS_ID, Sector_ID) |>
  mutate(
    Share_Fossil = max(Share_Fossil, na.rm = TRUE),
    Share_Renewables = max(Share_Renewables, na.rm = TRUE)
  ) |>
  ungroup() |> 
  mutate(
    Share_Fossil = ifelse(is.infinite(Share_Fossil) | is.nan(Share_Fossil), NA, Share_Fossil),
    Share_Renewables = ifelse(is.infinite(Share_Renewables) | is.nan(Share_Renewables), NA, Share_Renewables)
  )

### OUTPUT
writexl::write_xlsx(
  regional_energy_c |> 
    select(
      Country, NUTS_ID, Sector_ID, Source,
      Regional_Share, Energy_TJ, Regional_Energy_TJ,
      Regional_Energy_Norm, Share_Fossil, Share_Renewables
    ),
  "Outputs/Data/Energy_FEC_Data.xlsx"
)
