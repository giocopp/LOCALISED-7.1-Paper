setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Labor")

### INSTALL PACKAGES

remotes::install_github(
  "eurostat/restatapi"
)

libs <- c(
  "restatapi",
  "tidyverse",
  "giscoR",
  "sf",
  "classInt"
)

installed_libs <- libs %in% rownames(
  installed.packages()
)

if (any(installed_libs == FALSE)) {
  install.packages(
    libs[!installed_libs],
    dependencies = TRUE
  )
}

invisible(
  lapply(
    libs, library,
    character.only = TRUE
  )
)

### GET DATA
### 
### Sectoral Employment Share per Region (Region's manufactury employment specialization)

indicator_df_og <- restatapi::get_eurostat_data(
  id = "sbs_r_nuts2021",
  filters = c("EMP_LOC_MFG_PC"),
  date_filter = c(2022, 2021),
  exact_match = F,
  label = F,
  cflags = T,
  keep_flags = T,
  verbose=F
)

indicator_df_f <- indicator_df_og |> 
  dplyr::select(1, 3, 4, 5, 6) |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "Empl_pers" = "values",
    "Sector" = "nace_r2",
    "Time" = "time",
    "Flags" = "flags"
  ) 

indicator_df_f <- indicator_df_f |> 
  dplyr::filter(substr(Sector, 1, 1) == "C") |> 
  dplyr::filter(nchar(as.character(NUTS_ID)) != 3) |> 
  dplyr::select(-5) |> 
  dplyr::filter(substr(NUTS_ID, 1, 2) != "ZZ")

base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data.xlsx") |> 
  dplyr::select(1, 3)

indicator_df_f <- base_data |> 
  dplyr::left_join(
    indicator_df_f,
    by = "NUTS_ID"
  )

indicator_df_f <- indicator_df_f |> 
  dplyr::select(c(NUTS_ID, dplyr::everything()))

### IMPUTATION OF MISSING VALUES with older values
# Impute missing 2022 values with corresponding 2021 values
indicator_df_f <- indicator_df_f %>%
  group_by(Sector, NUTS_ID) %>%  # Group by Sector and NUTS_ID
  mutate(
    Empl_pers = ifelse(
      Time == 2022 & is.na(Empl_pers), 
      Empl_pers[Time == 2021],         
      Empl_pers                        
    )
  ) %>%
  ungroup()

EMPL_persons_raw_data <- indicator_df_f |> 
  filter(Time == 2022)

### Unemployment

indicator_df <- restatapi::get_eurostat_data(
  id = "tgs00010",
  filters = c("Y_GE15", "TOTAL", "T"), 
  date_filter = c(2023),
  exact_match = T,
  label = F,
  cflags = T,
  keep_flags = T
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "Unempl_Rate" = "values"
  ) |> 
  select(NUTS_ID, Unempl_Rate)

# Load the datasets
base_data <- readxl::read_excel("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Base Data/base_data.xlsx") |> 
  dplyr::select(1, 3)

Eurostat_unempl_rate <- base_data |> 
  dplyr::left_join(
    indicator_df_f,
    by = "NUTS_ID") |> 
  select(!NUTS_NAME)

### Labour market slack

indicator_df <- restatapi::get_eurostat_data(
  id = "lfst_r_sla_ga",
  filters = c("Y15-74", "PC_ELF", "T"), 
  date_filter = c(2022, 2021, 2019),
  exact_match = T,
  label = F,
  cflags = T,
  keep_flags = T
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "Lab_M_Slack" = "values",
    "Year" = "time"
  ) |> 
  select(NUTS_ID, Year, Lab_M_Slack)

Eurostat_lab_m_slack <- base_data |> 
  dplyr::left_join(
    indicator_df_f,
    by = "NUTS_ID") |> 
  select(!NUTS_NAME)

### Labor Productivity
### 
### GDP

indicator_df <- restatapi::get_eurostat_data(
  id = "nama_10r_2gdp",
  filters = c("MIO_EUR"), 
  date_filter = c(2021),
  exact_match = T,
  label = F,
  cflags = T,
  keep_flags = T
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "GDP" = "values",
  ) |> 
  select(NUTS_ID, GDP)

Eurostat_gdp <- base_data |> 
  dplyr::left_join(
    indicator_df_f,
    by = "NUTS_ID") |> 
  select(!NUTS_NAME)

### 
### Thousands of hours worked

indicator_df <- restatapi::get_eurostat_data(
  id = "nama_10r_2emhrw",
  filters = c("EMP", "TOTAL"), 
  date_filter = c(2021),
  exact_match = T,
  label = F,
  cflags = T,
  keep_flags = T
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "THW" = "values",
  ) |> 
  select(NUTS_ID, THW)

Eurostat_thw <- base_data |> 
  dplyr::left_join(
    indicator_df_f,
    by = "NUTS_ID") |> 
  select(!NUTS_NAME)

### NEETs

indicator_df <- restatapi::get_eurostat_data(
  id = "edat_lfse_22",
  filters = c("Y18-29", "T"), 
  date_filter = c(2022, 2021, 2019),
  exact_match = T,
  label = F,
  cflags = T,
  keep_flags = T
)

indicator_df_f <- indicator_df |> 
  dplyr::rename(
    "NUTS_ID" = "geo",
    "NEETs" = "values",
    "Year" = "time"
  ) |> 
  select(NUTS_ID, Year, NEETs)

Eurostat_neets <- base_data |> 
  dplyr::left_join(
    indicator_df_f,
    by = "NUTS_ID") |> 
  select(!NUTS_NAME)

# Save the updated dataset
# Save Regional Empl
writexl::write_xlsx(
  EMPL_persons_raw_data,
  "Outputs/Data/EMPL_persons_raw_data.xlsx")

# Save the updated dataset for Unemployment Rate
writexl::write_xlsx(
  Eurostat_unempl_rate,
  "Outputs/Data/Eurostat_unempl_rate.xlsx"
)

# Save the updated dataset for Labour Market Slack
writexl::write_xlsx(
  Eurostat_lab_m_slack,
  "Outputs/Data/Eurostat_lab_m_slack.xlsx"
)

# Save the updated dataset for GDP (Labor Productivity)
writexl::write_xlsx(
  Eurostat_gdp,
  "Outputs/Data/Eurostat_gdp.xlsx"
)

# Save the updated dataset for Thousands of Hours Worked
writexl::write_xlsx(
  Eurostat_thw,
  "Outputs/Data/Eurostat_thw.xlsx"
)

# Save the updated dataset for NEETs
writexl::write_xlsx(
  Eurostat_neets,
  "Outputs/Data/Eurostat_neets.xlsx"
)

return(c(
  "Outputs/Data/EMPL_persons_raw_data.xlsx",
  "Outputs/Data/Eurostat_unempl_rate.xlsx",
  "Outputs/Data/Eurostat_lab_m_slack.xlsx",
  "Outputs/Data/Eurostat_gdp.xlsx",
  "Outputs/Data/Eurostat_thw.xlsx",
  "Outputs/Data/Eurostat_neets.xlsx"
))
