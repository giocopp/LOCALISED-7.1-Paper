setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Labor")

### UNEMPLOYMENT RATE
unempl_rate <- readxl::read_xlsx("Outputs/Data/Eurostat_unempl_rate.xlsx")

unempl_rate <- unempl_rate %>%
  filter(nchar(as.character(NUTS_ID)) != 2)

# Extract the country code (first two characters of NUTS_ID)
unempl_rate <- unempl_rate %>%
  mutate(country_code = substr(as.character(NUTS_ID), 1, 2))

unempl_rate <- unempl_rate %>%
  mutate(unempl_rate = as.numeric(as.character(Unempl_Rate)))  

# Calculate the average unemployment rate per country
country_avg <- unempl_rate %>%
  group_by(country_code) %>%
  summarise(avg_unempl_rate = round(mean(Unempl_Rate, na.rm = TRUE), 2))

# Impute NA with the average unemployment rate per country
unempl_rate <- unempl_rate %>%
  left_join(country_avg, by = "country_code") %>%
  mutate(unempl_rate = coalesce(unempl_rate, avg_unempl_rate)) %>%
  select(-avg_unempl_rate, -Unempl_Rate, -country_code) |> 
  rename(Unempl_Rate = unempl_rate)

### LABOR MARKET SLACK
lab_m_slack <- readxl::read_xlsx("Outputs/Data/Eurostat_lab_m_slack.xlsx") |> 
  filter(Year == 2022)

# Filter out regions identified by a two-character NUTS_ID (country code)
lab_m_slack <- lab_m_slack %>%
  filter(nchar(as.character(NUTS_ID)) != 2)

# Extract the country code (first two characters of NUTS_ID)
lab_m_slack <- lab_m_slack %>%
  mutate(country_code = substr(as.character(NUTS_ID), 1, 2))

# Convert 'Lab_M_Slack' to numeric
lab_m_slack <- lab_m_slack %>%
  mutate(lab_m_slack = as.numeric(as.character(Lab_M_Slack)))

# Calculate the average labor market slack per country
country_avg <- lab_m_slack %>%
  group_by(country_code) %>%
  summarise(avg_lab_m_slack = round(mean(lab_m_slack, na.rm = TRUE), 2))

# Impute NAs with the average labor market slack per country
lab_m_slack <- lab_m_slack %>%
  left_join(country_avg, by = "country_code") %>%
  mutate(lab_m_slack = coalesce(lab_m_slack, avg_lab_m_slack)) %>%
  select(-avg_lab_m_slack, -Lab_M_Slack, -country_code, -Year) %>%
  rename(Lab_M_Slack = lab_m_slack)

### LABOR PRODUCTIVITY
gdp <- readxl::read_xlsx("Outputs/Data/Eurostat_gdp.xlsx")
thw <- readxl::read_xlsx("Outputs/Data/Eurostat_thw.xlsx")

# Merge GDP and THW data by NUTS_ID
lab_prod <- gdp %>%
  left_join(thw, by = "NUTS_ID")

# Create the labor productivity variable (GDP / THW)
lab_prod <- lab_prod %>%
  mutate(Labor_Prod = GDP / THW) |> 
  select(NUTS_ID, Labor_Prod)

### NEETS
neets <- readxl::read_xlsx("Outputs/Data/Eurostat_neets.xlsx")

# Filter for 2022 and exclude regions identified by a two-character NUTS_ID (country code)
neets <- neets %>%
  filter(nchar(as.character(NUTS_ID)) != 2) %>%
  filter(Year == 2022)

# Extract the country code (first two characters of NUTS_ID)
neets <- neets %>%
  mutate(country_code = substr(as.character(NUTS_ID), 1, 2))

# Convert 'NEETs' column to numeric
neets <- neets %>%
  mutate(NEETs = as.numeric(as.character(NEETs)))

# Calculate the average NEETs per country and round it to 2 decimal places
country_avg <- neets %>%
  group_by(country_code) %>%
  summarise(avg_NEETs = round(mean(NEETs, na.rm = TRUE), 2))

# Impute NAs in 'NEETs' with the average NEETs per country
neets <- neets %>%
  left_join(country_avg, by = "country_code") %>%
  mutate(NEETs = coalesce(NEETs, avg_NEETs)) %>%
  select(-avg_NEETs, -country_code, -Year) 

### AGGREGATE
# Step 1: Merge all datasets into one dataset by 'NUTS_ID' or 'country_code'
labor_aggregate <- unempl_rate %>%
  left_join(lab_m_slack, by = "NUTS_ID") %>%
  left_join(lab_prod, by = "NUTS_ID") %>%
  left_join(neets, by = "NUTS_ID")

# Step 2: Normalize the relevant numeric columns using Min-Max scaling
# We will apply min-max normalization to all numeric columns (except for NUTS_ID)
labor_aggregate <- labor_aggregate %>%
  mutate(across(where(is.numeric), ~ ( . - min(. , na.rm = TRUE)) / (max(.) - min(., na.rm = TRUE))))

# Invert columns that have negative relationship with vulnerability
labor_aggregate <- labor_aggregate %>%
  mutate(across(c("Labor_Prod"), ~ 1 - .))

# Step 3: Calculate the labor indicator using the geometric mean
# Ensure all selected columns are numeric for calculation
labor_aggregate <- labor_aggregate %>%
  mutate(Labor_Index = exp(rowMeans(
    log(select(., starts_with("unempl_rate"), starts_with("Lab_M_Slack"), starts_with("Labor_Prod"), starts_with("NEETs"))), 
    na.rm = TRUE
  )))

labor_aggregate <- labor_aggregate %>%
  mutate(Labor_Index = (Labor_Index - min(Labor_Index, na.rm = TRUE)) / (max(Labor_Index, na.rm = TRUE) - min(Labor_Index, na.rm = TRUE)))

# Check the min and max of the Labor_Index
max(labor_aggregate$Labor_Index)
min(labor_aggregate$Labor_Index)

# Save the updated dataset
writexl::write_xlsx(
  labor_aggregate,
  "Outputs/Data/Labor_Index.xlsx")

return("Outputs/Data/Labor_Index.xlsx")
