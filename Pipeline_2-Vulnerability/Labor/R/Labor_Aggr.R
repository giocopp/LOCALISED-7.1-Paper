# Set working directory and load required libraries
setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Labor")
library(readxl)
library(dplyr)
library(tidyr)
library(writexl)

###############################################
### 1. EMPLOYMENT REGION (Saved Separately) ###
###############################################

# empl_region <- readxl::read_xlsx("Outputs/Data/EMPL_persons_raw_data.xlsx")
# 
# # Impute missing employment values using median by Sector (drop Time if present)
# empl_region <- empl_region %>%
#   select(-Time) %>% 
#   group_by(Sector) %>%
#   mutate(Empl_pers = if_else(is.na(Empl_pers),
#                              median(Empl_pers, na.rm = TRUE),
#                              Empl_pers)) %>%
#   ungroup()
# 
# # Save the employment region data (without normalization)
# writexl::write_xlsx(empl_region, "Outputs/Data/EMPL_Region.xlsx")

###############################################
### 2. UNEMPLOYMENT RATE (Median Imputation) ###
###############################################

unempl_rate <- readxl::read_xlsx("Outputs/Data/Eurostat_unempl_rate.xlsx") %>%
  filter(nchar(as.character(NUTS_ID)) != 2) %>%
  mutate(country_code = substr(as.character(NUTS_ID), 1, 2),
         Unempl_Rate = as.numeric(as.character(Unempl_Rate)))

# Compute the median unemployment rate by country and impute missing values
country_median_unempl <- unempl_rate %>%
  group_by(country_code) %>%
  summarise(median_unempl = median(Unempl_Rate, na.rm = TRUE))
unempl_rate <- unempl_rate %>%
  left_join(country_median_unempl, by = "country_code") %>%
  mutate(Unempl_Rate = coalesce(Unempl_Rate, median_unempl)) %>%
  select(-median_unempl, -country_code)

###############################################
### 3. LABOR MARKET SLACK (Median Imputation) ###
###############################################

lab_m_slack <- readxl::read_xlsx("Outputs/Data/Eurostat_lab_m_slack.xlsx") %>%
  filter(Year == 2022) %>%
  filter(nchar(as.character(NUTS_ID)) != 2) %>%
  mutate(country_code = substr(as.character(NUTS_ID), 1, 2),
         Lab_M_Slack = as.numeric(as.character(Lab_M_Slack)))

# Compute the median slack by country and impute missing values
country_median_slack <- lab_m_slack %>%
  group_by(country_code) %>%
  summarise(median_slack = median(Lab_M_Slack, na.rm = TRUE))
lab_m_slack <- lab_m_slack %>%
  left_join(country_median_slack, by = "country_code") %>%
  mutate(Lab_M_Slack = coalesce(Lab_M_Slack, median_slack)) %>%
  select(-median_slack, -country_code, -Year)

###############################################
### 4. LABOR PRODUCTIVITY (Median Imputation)  ###
###############################################

gdp <- readxl::read_xlsx("Outputs/Data/Eurostat_gdp.xlsx")
thw <- readxl::read_xlsx("Outputs/Data/Eurostat_thw.xlsx")

# Merge GDP and THW data by NUTS_ID and compute Labor Productivity
lab_prod <- gdp %>%
  left_join(thw, by = "NUTS_ID") %>%
  mutate(Labor_Prod = GDP / THW) %>%
  select(NUTS_ID, Labor_Prod)

# Impute any missing Labor_Prod using the overall median
overall_median_lab_prod <- median(lab_prod$Labor_Prod, na.rm = TRUE)
lab_prod <- lab_prod %>%
  mutate(Labor_Prod = if_else(is.na(Labor_Prod), overall_median_lab_prod, Labor_Prod))

###############################################
### 5. NEETS (Median Imputation)              ###
###############################################

neets <- readxl::read_xlsx("Outputs/Data/Eurostat_neets.xlsx") %>%
  filter(nchar(as.character(NUTS_ID)) != 2) %>%
  filter(Year == 2022) %>%
  mutate(country_code = substr(as.character(NUTS_ID), 1, 2),
         NEETs = as.numeric(as.character(NEETs)))

# Compute the median NEETs by country and impute missing values
country_median_neets <- neets %>%
  group_by(country_code) %>%
  summarise(median_neets = median(NEETs, na.rm = TRUE))
neets <- neets %>%
  left_join(country_median_neets, by = "country_code") %>%
  mutate(NEETs = coalesce(NEETs, median_neets)) %>%
  select(-median_neets, -country_code, -Year)

###############################################
### 6. AGGREGATE & CALCULATE LABOR INDEX       ###
###############################################

# Merge all indicators by NUTS_ID
labor_aggregate <- unempl_rate %>%
  left_join(lab_m_slack, by = "NUTS_ID") %>%
  left_join(lab_prod, by = "NUTS_ID") %>%
  left_join(neets, by = "NUTS_ID")

# Ensure no missing numeric values remain (impute any remaining NAs with overall medians)
labor_aggregate <- labor_aggregate %>%
  mutate(across(where(is.numeric), ~ if_else(is.na(.), median(., na.rm = TRUE), .)))

# -----------------------------
# MIN-MAX NORMALIZATION 
# -----------------------------
# We normalize the four variables (Unempl_Rate, Lab_M_Slack, Labor_Prod, NEETs) to a 0.01â€“0.99 scale.
# For Labor_Prod we invert the normalized value (i.e. 1 - normalized value).
labor_aggregate <- labor_aggregate %>%
  mutate(
    Unempl_Rate_norm = 0.01 + ((Unempl_Rate - min(Unempl_Rate)) / (max(Unempl_Rate) - min(Unempl_Rate)))*(0.99 - 0.01),
    Lab_M_Slack_norm  = 0.01 + ((Lab_M_Slack - min(Lab_M_Slack)) / (max(Lab_M_Slack) - min(Lab_M_Slack)))*(0.99 - 0.01),
    Labor_Prod_norm   = 0.01 + ((Labor_Prod - min(Labor_Prod)) / (max(Labor_Prod) - min(Labor_Prod)))*(0.99 - 0.01),
    Labor_Prod_norm   = 1 - Labor_Prod_norm,  # invert Labor Productivity
    NEETs_norm        = 0.01 + ((NEETs - min(NEETs)) / (max(NEETs) - min(NEETs)))*(0.99 - 0.01)
  )

# Compute the Labor Vulnerability Index as the average of the normalized indicators
labor_aggregate <- labor_aggregate %>%
  mutate(Labor_Index = rowMeans(select(., Unempl_Rate_norm, Lab_M_Slack_norm, Labor_Prod_norm, NEETs_norm)))

labor_aggregate <- labor_aggregate %>%
  mutate(Labor_Index = rowMeans(select(., Unempl_Rate_norm, Lab_M_Slack_norm, Labor_Prod_norm, NEETs_norm))) %>%
  mutate(Labor_Index = 0.01 + ((Labor_Index - min(Labor_Index, na.rm = TRUE)) /
                                 (max(Labor_Index, na.rm = TRUE) - min(Labor_Index, na.rm = TRUE)))*(0.99 - 0.01))

###############################################
### 7. ADD SECTOR INFORMATION                 ###
###############################################

# Define Sector_ID vector (note: these do not alter the underlying indicator values)
Sector_ID <- c("C", "C10-C12", "C13-C15", "C16-C18", "C19-C20", "C21-C22", 
               "C23", "C24", "C25+C28-C30", "C26-C27", "C31-C32", "C33")

# Cross-join the sector information with the aggregated dataset
labor_aggregate <- labor_aggregate %>% 
  tidyr::crossing(Sector_ID) %>% 
  select(NUTS_ID, Sector_ID, everything())

###############################################
### 8. SAVE THE FINAL DATASET                 ###
###############################################

writexl::write_xlsx(labor_aggregate, "Outputs/Data/Labor_Index.xlsx")
cat("Output saved to Outputs/Data/Labor_Index.xlsx\n")

View(labor_aggregate)
