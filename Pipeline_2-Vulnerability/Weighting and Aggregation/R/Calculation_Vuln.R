setwd("/Users/giocopp/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Weighting and Aggregation")

Vulnerability_Index <- read_excel(
  path = "~/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Weighting and Aggregation/Outputs/Data/Index_Data.xlsx"
)

### 
model <- lm(Exposure_Index ~ Energy_Index + Labor_Index + Sup_Ch_Index + 
              Tech_Index + Finance_Index + Inst_Index, data = Vulnerability_Index)

summary(model)

# Define weights (must match the columns ending with "Index")
# Define columns and weights
columns <- c("Energy_Index", "Labor_Index", "Sup_Ch_Index", "Tech_Index", "Finance_Index", "Inst_Index")
weights <- c(2, 1, 1, 1, 1, 1)  # Example weights: Energy_Index is more important
weights <- weights / sum(weights)  # Normalize weights to sum to 1

# Calculate the weighted geometric mean
Vulnerability_Index <- Vulnerability_Index |> 
  rowwise() |>  # Process row by row
  mutate(
    Vulnerability_Index = exp(
      sum(
        log(c_across(all_of(columns))) * weights, na.rm = TRUE
      ) / 
        sum(weights[!is.na(c_across(all_of(columns)))])  # Adjust weights for non-NA values
    )
  ) |> 
  ungroup()


Vulnerability_Index <- Vulnerability_Index |> 
  mutate(
    Vulnerability_Index = case_when(
      # Normalize sector "C" separately
      Sector_ID == "C" ~ 0.01 + 
        (Vulnerability_Index - min(Vulnerability_Index[Sector_ID == "C"], na.rm = TRUE)) / 
        (max(Vulnerability_Index[Sector_ID == "C"], na.rm = TRUE) - 
           min(Vulnerability_Index[Sector_ID == "C"], na.rm = TRUE)) * (0.99 - 0.01),
      
      # Normalize other sectors
      TRUE ~ 0.01 + 
        (Vulnerability_Index - min(Vulnerability_Index[Sector_ID != "C"], na.rm = TRUE)) / 
        (max(Vulnerability_Index[Sector_ID != "C"], na.rm = TRUE) - 
           min(Vulnerability_Index[Sector_ID != "C"], na.rm = TRUE)) * (0.99 - 0.01)
    )
  )

write_xlsx(Vulnerability_Index, "~/Desktop/LOCALISED-7.1-Paper/Pipeline_2-Vulnerability/Weighting and Aggregation/Outputs/Data/Vulnerability_Index.xlsx")

return("Outputs/Data/Vulnerability_Index.xlsx")

